<h4 class="header-underline">Evidence information</h4>
<% if @issue.affected.any? %>
  <%= render 'issues/add_evidence'%>
  <table class="table table-striped mb-0"
    data-behavior="dradis-datatable"
    data-default-columns='["Node", "Created", "Updated"]'
    data-item-name=<%= "issue_#{@issue.id}_evidence" %>
    data-evidence-templates="<%= @evidence_templates.map { |t| [t.id, t.name, t.content] }.to_json %>"
    data-local-storage-key="project.ce.<%= dom_id(current_project) %>.<%= "issue_#{@issue.id}_evidence_datatable" %>">
    <thead>
      <tr>
        <% @evidence_columns.each do |column| %>
          <th><%= column %></th>
        <% end %>
        <th class="no-sort" data-column-visible="false"><span class="sr-only">Actions</span></th>
      </tr>
    </thead>
    <tbody>
      <% @affected_nodes.each do |node| %>
        <% node.evidence.where(issue_id: @issue.id).each do |evidence| %>
          <tr id="issue-<%= evidence.issue.id %>-evidence-<%= evidence.id %>">
            <% @evidence_columns.each do |column| %>
              <%
                sort, display =
                case column
                when 'Node'
                  [evidence.node.label, link_to(evidence.node.label, [current_project, node, evidence])]
                when 'Created'
                  [evidence.created_at.to_i, local_time_ago(evidence.created_at)]
                when 'Created by'
                  [evidence.author, evidence.author]
                when 'Updated'
                  [evidence.updated_at.to_i, local_time_ago(evidence.updated_at)]
                else
                  [evidence.fields.fetch(column, ''), markup(evidence.fields.fetch(column, ''))]
                end
              %>
              <td data-sort="<%= sort %>"><%= display %></td>
            <% end  %>
            <td class="column-actions">
              <%= link_to edit_project_node_evidence_path(current_project, node, evidence, return_to: :issue) do %>
                  <i class="fa fa-pencil"></i> Edit
                <% end %>
              <%= link_to [current_project, node, evidence],
                    class: 'text-error-hover',
                    data: { confirm: "Are you sure?\n\nProceeding will delete this evidence from the associated node." },
                    method: :delete do %>
                <i class="fa fa-trash"></i> Delete
              <% end %>
            </td>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
<% else %>
  <div class="empty-state mt-3">
    <div class="empty-state-icon">
      <%= image_tag "icons/#{rand(9)}.svg" %>
    </div>
    <div class="empty-state-body">
      <div class="container">
        <h4 class="empty-state-title">This issue doesn't have any evidence yet</h4>
        <p class="empty-state-body-text mb-1">Use evidence to document the details that change from one instance of the issue to the next.</p>
        <p class="empty-state-body-text">Some examples include: port number, specific versions, output of tools (e.g. the list of SSL ciphers, etc.)</p>
        <div class="empty-state-actions">
          <a href="https://dradisframework.com/support/guides/projects/issues.html"
          class="empty-state-docs-link" target="_blank">More about issues and evidence</a>
        </div>
      </div>
    </div>
  </div>
<% end %>
