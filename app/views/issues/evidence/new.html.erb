<% content_for :title, "Add new evidence for #{@issue.title}" %>

<% content_for :breadcrumbs do %>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to 'All issues', project_issues_path(current_project) %></li>
      <li class="breadcrumb-item"><%= link_to @issue.title, project_issue_path(current_project, @issue, tab: 'evidence-tab') %></li>
      <li class="breadcrumb-item active">New Evidence</li>
    </ol>
  </nav>
<% end %>

<% content_for :sidebar do %>
  <%= render 'issues/sidebar', issues: @issues %>
<% end %>

<div class="content-container">
  <div id="issues_editor">
    <div class="note-text-inner">
      <h4 class="header-underline">Add new evidence</h4>

      <div class="col-12 add-evidence-container" data-behavior="add-evidence-container">
        <%= form_for(
          :evidence,
          url: project_create_multiple_evidence_path(current_project),
          html: {
            id: 'add-evidences',
            data: {
              behavior: 'local-auto-save',
              auto_save_key: @auto_save_key
            }
          }
        ) do |f| %>
          <% cache [@issue, @nodes_for_add_evidence ] do %>
            <div class="row">
              <div class="col-12">
                <%= f.hidden_field :issue_id, value: @issue.id %>
                <%= f.hidden_field :node_id %>

                <%= f.label :content, nil, class: 'sr-only' %>
                <%=
                  f.text_area :content,
                  label: false,
                  class: 'textile form-control',
                  data: {
                    allow_dropdown: true,
                    behavior: 'auto-save rich-toolbar drop-zone',
                    paths: editor_paths,
                    'rich-toolbar': 'block-code bold field image italic link list-ol list-ul table',
                    'rich-toolbar-uploader': '[data-behavior~=jquery-upload]',
                  },
                  rows: 20
                %>
              </div>
            </div>
            <hr>
            <div class="row">
              <div class="col-6">
                <%= f.label 'Add to existing nodes', for: :evidence_node %>
                <%= f.text_field :node, class: 'form-control', placeholder: 'Type here to filter list...' %>

                <div id="existing-node-list" class="form-check mt-3">
                  <%= f.collection_check_boxes(:node_ids, @nodes_for_add_evidence, :id, :label) do |b| %>
                    <div data-behavior="existing-node-wrapper">
                      <%= b.check_box class: 'form-check-input' %>
                      <%= b.label class: 'form-check-label', data: { behavior: 'existing-node-label'} %>
                    </div>
                  <% end %>
                </div>
              </div>
              <div class="col-6">
                <label for="evidence_node_list">Paste list of nodes
                  <i
                    class="fa fa-question-circle"
                    data-toggle="tooltip"
                    data-html="true"
                    data-placement="right"
                    role="tooltip"
                    title="<ul><li>If a node in this list already exists in the project, evidence will be added to it.</li><li>If a node doesn't exist, it will be created and then evidence will be added.</li></ul>"></i>
                </label>
                <%= f.text_area :node_list, rows: 7, placeholder: 'One node per line...', class: 'form-control' %>

                <%= f.label 'Create new nodes under', for: :evidence_node_list_parent_id , class: 'mt-4' %>
                <%= f.collection_select(
                  :node_list_parent_id,
                  @nodes_for_add_evidence,
                  :id,
                  :label,
                  { include_blank: 'The root of the tree' },
                  { :class => 'custom-select' }
                ) %>
              </div>
            </div>

            <div class="form-actions">
              <%= f.submit class: 'btn btn-primary' %> or
              <%= link_to 'Cancel', project_issue_path(current_project, @issue, tab: 'evidence-tab'), class: 'cancel-link', data: { behavior: 'clear-local-auto-save' } %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
